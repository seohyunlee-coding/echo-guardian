{% extends 'blog/base.html' %}
{% block content %}


<div class="notice-box" style="margin:6px 0 4px 0; padding:8px 0;"> 
  <div class="notice-inner"> 
    <div style="display:flex;align-items:center;gap:12px;"> 
      <span style="font-weight:600;">âš ï¸ ì‹ ê·œ ë°œìƒ ì•Œë¦¼</span> 
      <div style="font-size:0.95rem;color:#333;"> 
        {% if recent_posts %} 
        {% for r in recent_posts %} 
        <a href="{% url 'blog:post_detail' r.pk %}" style="margin-right:10px;text-decoration:none;color:inherit;">{{ r.title }}</a> 
        {% endfor %} {% else %} <span style="color:#666;">ìµœê·¼ 5ë¶„ ë‚´ ì‹ ê·œ ì‹ ê³ ê°€ ì—†ìŠµë‹ˆë‹¤.</span> 
        {% endif %} 
      </div> 
      </div>
     </div> 
    </div>


<div class="notice-box" style="margin-top:8px;">
  <div class="notice-inner">
    <a href="{% url 'blog:stats_separ' %}" class="notice-main btn btn-primary"
      style="text-decoration:none;display:inline-flex;align-items:center;gap:8px;">
      ğŸ—‘ï¸ ë¶„ë¦¬ìˆ˜ê±° ì˜¤ë¥˜: <strong>{{ separ_count|default:0 }}ê±´</strong>
    </a>
    <span class="notice-sep">/</span>
    <a href="{% url 'blog:stats_illegal' %}" class="notice-main btn btn-secondary"
      style="text-decoration:none;display:inline-flex;align-items:center;gap:8px;">
      ğŸš¯ ë¬´ë‹¨ íˆ¬ê¸° ê°ì§€: <strong>{{ illegal_count|default:0 }}ê±´</strong>
    </a>
  </div>
</div>



    

<div class="dashboard-header">
  <div class="dashboard-title-wrap">
    <h2 class="dashboard-title">ì‹ ê³  ëª©ë¡</h2>
    <p class="dashboard-subtitle">ì‹ ê³ ëœ í¬ìŠ¤íŠ¸</p>
  </div>
  {% if user.is_authenticated %}
  <a href="{% url 'blog:post_new' %}" class="btn btn-create">+ ìƒˆ ì‹ ê³  í¬ìŠ¤íŠ¸ ì‘ì„±</a>
  {% endif %}
</div>

<div class="search-bar" style="margin:18px 0;display:flex;align-items:center;gap:8px;">
  <form method="get" action="{% url 'blog:post_list' %}" style="display:flex;flex:1;">
    <input type="search" name="q" placeholder="ê²€ìƒ‰ì–´ë¡œ í¬ìŠ¤íŠ¸ë¥¼ ì°¾ì•„ë³´ì„¸ìš”" value="{{ q|default:'' }}" aria-label="ê²€ìƒ‰" style="flex:1;padding:8px 10px;border:1px solid #ddd;border-radius:6px;">
    <button type="submit" class="btn btn-primary" style="margin-left:8px;padding:8px 12px;border-radius:6px;">ê²€ìƒ‰</button>
  </form>
</div>



{% if posts %}
<div class="post-list">
  {% for post in posts %}
  <article class="post-card">
    <a href="{% url 'blog:post_detail' post.pk %}" class="card-link">
      <div class="card-image-wrap">
        {% if post.image %}
        <img src="{{ post.image.url }}" alt="{{ post.title }}" class="card-image">
        {% else %}
        <div class="card-image-placeholder">ì´ë¯¸ì§€ ì—†ìŒ</div>
        {% endif %}
      </div>
      <div class="card-body">
        <h3 class="card-title">{{ post.title }}</h3>
        <p class="card-excerpt">{{ post.text|truncatechars:100 }}</p>
        <div class="card-meta">
          <span class="card-date">{{ post.published_date|date:"Yë…„ nì›” jì¼" }}</span>
          <span class="card-author">{{ post.author.username }}</span>
          <label style="margin-left:12px;display:inline-flex;align-items:center;gap:6px;font-size:0.9rem;">
            <input type="checkbox" class="processed-checkbox" data-post-id="{{ post.pk }}" {% if post.processed %}checked{% endif %}>
            ì²˜ë¦¬ì™„ë£Œ
          </label>
        </div>
      </div>
    </a>
  </article>
  {% endfor %}
</div>
{% else %}
<div class="empty-state">
  <div class="empty-icon">ğŸ“­</div>
  <p class="empty-text">ì•„ì§ ë“±ë¡ëœ í¬ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</p>
  <p class="empty-subtext">ìƒˆ í¬ìŠ¤íŠ¸ë¥¼ ë“±ë¡í•´ì£¼ì„¸ìš”</p>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.processed-checkbox').forEach(function (cb) {
      cb.addEventListener('change', function () {
        const pk = this.dataset.postId;
        const processed = this.checked;
        const csrftoken = getCookie('csrftoken');
        fetch('{% url "blog:toggle_processed" 0 %}'.replace('0', pk), {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          body: 'processed=' + (processed ? '1' : '0')
        }).then(function (res) {
          if (!res.ok) {
            throw new Error('Network response was not ok');
          }
          return res.json();
        }).then(function (data) {
          if (data.error) {
            alert('ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
            cb.checked = !processed;
          }
        }).catch(function (err) {
          console.error(err);
          alert('ì²˜ë¦¬ ìƒíƒœ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          cb.checked = !processed;
        });
      });
    });
  });
</script>
{% endblock %}